## KRC Global Map — Assistant Guide (요약)

목적

- 이 저장소에서 코드 보조 도구(assistant)가 작업할 때 필요한 개요와 규칙을 제공합니다.

개요

- 정적(Static) Leaflet 웹앱으로 ODA/Consulting 프로젝트를 세계 지도에 표시합니다.
- 백엔드/Firebase 미사용. 데이터는 `KRC/data/`의 JSON 두 파일에서 로드합니다.
- 브라우저 내 편집 모드: 운영 빌드에서는 비활성화되어 있습니다(버튼 숨김/`editMode=false`). 개발 시에만 복구.
- 주소+사업명 통합 검색(Nominatim + 부분 문자열 매칭).

핵심 파일/디렉터리

- `index.html`: 단일 파일에 HTML/CSS/JS가 모두 포함(지도, 편집, 패널 로직).
- `data/global_oda.json`, `data/global_consulting.json`: 데이터 소스.
- `scripts/convert_xlsx_to_json.py`: Excel → JSON 변환 스크립트(openpyxl 사용).
- `package.json`, `scripts/dev-server.js`, `scripts/serve.sh`: 로컬 서버 실행 도구.
- `archive/versions/`: 과거 스냅샷(레거시 Firebase 코드 포함, 런타임에 사용 안 함).

실행 방법

- npm: `npm start` (포트 변경: `PORT=8080 npm start`)
- Python: `PORT=8000 bash scripts/serve.sh`
- 접속: `http://localhost:8000/` (루트에서 `index.html` 직접 서빙)

데이터 플로우

- Excel → JSON: `python3 scripts/convert_xlsx_to_json.py`
- 앱 로드 → `data/*.json` 로딩 → 프로젝트별 마커 표시.
- 편집 모드: “✏️ 편집 모드” → 팝업의 “편집” → 모달에서 저장.
- 좌표 조정: 선택된 마커를 직접 드래그(모달 위/경도 실시간 반영, 저장 시 확정).
- JSON 내보내기/불러오기: 우측 패널에서 실행(내보낸 파일은 `data/`에 반영하여 배포).

UI 구조(최신 v1.8)

### 데스크탑 레이아웃
- **우측 사이드 패널(오른쪽 1/3)**:
  - **통합 툴바**: 검색 + 카테고리 필터가 한 줄에 배치 (기본: 둘 다 활성)
  - **요약 카드**: 컨설팅/ODA 개수·합계 요약(필터/컨텍스트 기준)
  - **1x4 대륙 세로 배치**: 아시아/아프리카/아메리카/기타
  - **4개국 국기 그리드**: 각 대륙별 4개국/줄, 전체 국가명 표시 (줄바꿈 지원)
- **독립 편집 컨트롤**: 화면 우상단 고정 위치 (새 지점/내보내기/불러오기)
- **마커**: 프로젝트별 단일 마커(카테고리 테두리색, 배경에 국가 국기). 클러스터링은 현재 비활성화.
- **팝업**: 카테고리별 색상 테두리 (컨설팅: 진한파랑 #0A3D62, ODA: 진한주황 #E65100)

### 모바일 레이아웃
- **하단 패널**: 화면 하단 33% 차지 (이전 50%에서 최적화)
- **지도 중심점 자동 조정**: 패널 위치를 고려한 최적 뷰포트
- **4개국 국기 그리드**: 모바일에서도 4개국/줄 유지
- **무한 스크롤 제한**: 지도 경계 설정으로 사용성 개선

### 와인색 타임라인 시스템 (Compact + Gantt)
- 단일 와인색 선(#722F37) 위에 국가별 프로젝트를 정렬
- 선 위 굵은 와인색 점 + 아래 연도 라벨(정확한 범위 표시)
- 프로젝트 뱃지: 간트형 레인 배치로 겹침 방지
  - 기술컨설팅: 하늘색(#E3F2FD, 텍스트 #0A3D62)
  - ODA: 연한 주황(#FFF3E0, 텍스트 #E65100)
- 정확한 연도 범위: 해당 국가의 가장 이른 시작~가장 늦은 종료만 노출(패딩 없음)
- 수평 스크롤: 긴 타임라인은 좌우 스크롤로 탐색

코딩 원칙

- **단일 파일 아키텍처**: 모든 변경은 `index.html`에 최소 침습적으로 적용
- **스타일 톤 유지**:
  - 기본: 상아색(#FFF8E7) 바탕 + 진한 파랑(#0A3D62) 테두리
  - 와인색 시스템: 레드와인색(#722F37) 타임라인 요소
  - 카테고리 색상: 컨설팅(#0A3D62), ODA(#E65100)
- **의존성 관리**: 외부 의존성 추가 금지(CDN만 허용, 빌드/번들 없이 동작)
- **반응형 디자인**: 모바일 우선, 데스크탑 최적화
- **성능 최적화**: 무한 스크롤 방지, 지도 경계 설정, 자동 중심점 조정
- **아카이브 정책**: `archive/`는 참고용이며, 동기화/수정 대상이 아님

플래그/국가 허브

- `attachCountryHubHandlers()`: 국기 클릭 시 국가 통계 모달 표시 + `focusCountryOnMap(country)`로 지도 포커스
- 국기 칩 좌/우 배지: 좌측(Consulting), 우측(ODA) 개수 표시. 필터 상태 반영.
- ODA 토글 후 국가 누락 방지: 카테고리 양쪽 활성 시 클라이언트 필터를 자동 비움.

자주 겪는 이슈

- 로딩만 보일 때: 콘솔 에러 확인(필터 DOM 부재 접근, 템플릿 문자열 구문 오류 등). 방어 코드로 우회 가능.
- 포트 충돌/원격 접속: 포트 변경 또는 방화벽/보안그룹 개방.
- 지도/검색 비어 보임: OSM 타일·Nominatim은 인터넷 필요(오프라인 환경에서 제한적).

주요 기능 업데이트 (v1.9 - 2025.09.18)

### 📊 개황 팝업 최적화 (Overview Popup)
- **하단 공백 대폭 축소**: 모달 높이 85vh→80vh, 타임라인 컨테이너 60vh→50vh 제한
- **패딩 최소화**: 모달 바디 하단 패딩 24px→8px, 타임라인 컨테이너 20px→5px 축소
- **팝업 크기 적응**: flex 설정 변경으로 내용에 맞는 자동 크기 조정
- **공간 활용도 개선**: 타임라인이 팝업 범위에 적절히 맞춰 표시되도록 최적화

### 🔧 기술컨설팅 연도 표시 정확도 개선
- **날짜 파싱 강화**: 'YY-MM 형식에서 월과 연도 구분 정확도 향상
- **데이터 오류 수정**: backtick(`) → apostrophe(') 변환으로 파싱 안정성 확보
- **연도 순서 정확화**: 자동 연도 교체 로직 제거로 원본 데이터 순서 유지
- **표시 일관성**: 시작~종료 연도가 정확하게 타임라인에 반영

### 📌 발주처 필터/정규화 시스템 (우측 패널)
- 기술컨설팅만 선택 시 상단 요약 하단에 발주처 필터 바 표시
- 기본값: 모든 발주처 전체 선택 상태(버튼 active)
- 전체 버튼 토글: 한 번에 전체 선택/전체 해제 가능(전체 해제 시 컨설팅 사업 비표시)
- 필터 연동: 국가 국기 그리드도 선택된 발주처에 해당하는 국가만 표시
- 정규화 규칙(표시/필터 일원화)
  - WB/World Bank/WB(IDA)/IDA → 'WB'로 통일
  - '정부' 포함, Government/Ministry 포함, '브루나이' 관련 표기 → '각국정부'

### 🕒 타임라인 시스템 개선
- 현재시점: 레드와인색 점선 + 라벨을 [현재] 작은 칩 + 'YYYY.MM'로 축 바로 위에 표시
- 빈 해 압축: 프로젝트가 없는 연도는 간격 자체 제거(2011과 2013이 바로 붙음)
- 미래 사업 레이아웃: 현재시점 우측 전용 슬롯에 배치(겹침/혼동 방지)
- 미래 연도 라벨/와인점도 이벤트 위치로 함께 이동해 정렬 유지
- 월 단위 정밀도: 'YY-MM / YYYY-MM 파싱으로 시작년월-축 교차점 정확도 보장
- 진행중 스타일: 기술컨설팅(하늘색), ODA(진한 주황 #E65100, 흰 글씨) 차별화

### 🤏 모바일 제스처 줌
- 버튼 제거, 핀치(두 손가락) 제스처로 확대/축소(0.5x~3x)
- 배율 변경 시 레이아웃 재계산 + 현재시점 자동 스크롤 유지

### 🌍 분류/데이터 정리
- 대륙 분류: 아프가니스탄·이란을 '아시아'로 이동(중동 목록에서 제거)
- 엑셀/JSON 동기화: '정부'/브루나이/Ministry/Government 포함 발주처는 '각국정부'로, WB/IDA 계열은 'WB'로 엑셀/JSON 모두 정규화

---

주요 기능 업데이트 (v1.8 - 2025.09.17) - 이전 버전

---

주요 기능 업데이트 (v1.7 - 2025.09.16)

### 🎯 동적 타임라인 시스템 (혁신)
- **동적 레인 할당**: 최대 동시 사업 개수에 따라 4-10개 레인 자동 할당
- **완전 겹침 방지**: 픽셀 기반 충돌 검사로 25px 버퍼 간격 보장
- **현재년도까지 확장**: 2025년까지 프로젝트 기간 완전 표시
- **인도네시아 최적화**: 60개 프로젝트도 겹침 없이 완벽 표시

### 🎨 깔끔한 타임라인 디자인 (완전개선)
- **흰색 배경**: 레드와인색 배경 완전 제거, 깔끔한 흰색 적용
- **상아색 뱃지**: 모든 프로젝트 뱃지 통일된 상아색 배경
- **테두리 구분**: 기술컨설팅(진한파랑) vs ODA(진한주황) 3px 테두리로만 구분
- **연도 간격**: 연도 영역과 첫 번째 레인 사이 충분한 간격(50px) 확보

### 📋 완전한 정보 표시 (가독성 혁신)
- **사업명 강조**: 13px, 굵은 글씨로 사업명이 가장 눈에 띄게 표시
- **라벨화된 정보**: 연도, 예산, 발주처 등 배경색이 있는 라벨로 구분
- **구조화된 레이아웃**: 사업명 → 상세정보 → 발주처 순 명확한 계층
- **상세 툴팁**: 호버 시 모든 프로젝트 정보 완전 표시

### 🚀 성능 및 가독성 최적화
- **동적 너비 계산**: 프로젝트 기간과 밀도에 따른 적응형 타임라인 너비
- **스마트 스크롤**: 긴 역사의 경우 수평 스크롤로 자연스러운 탐색
- **뱃지 크기 최적화**: 40px 높이로 더 많은 정보 수용
- **진행 상태 표시**: 진행중 프로젝트는 애니메이션과 특별 스타일

테스트 체크리스트 (v1.9)

### 🚀 기본 기능 테스트
- `npm start`로 서버 실행 후 마커 렌더링 확인
- 편집 모드에서 마커 드래그 → 모달 좌표 갱신 확인 → 저장 후 JSON 내보내기 확인
- 검색창에 사업명 일부(예: "까리안") 입력 시 해당 프로젝트 위치로 이동 확인
- 개황 버튼 클릭 → 전체 프로젝트 타임라인 표시 확인

### 📊 개황 팝업 최적화 테스트
- 개황 팝업 하단 공백이 최소화되어 표시되는지 확인
- 타임라인이 팝업 범위에 적절히 맞춰 표시되는지 확인
- 모달 크기가 내용에 맞게 자동 조정되는지 확인

### 🔧 연도 표시 정확도 테스트
- 기술컨설팅 프로젝트의 시작~종료 연도가 정확히 표시되는지 확인
- 'YY-MM 형식 날짜가 올바르게 파싱되는지 확인
- 연도 순서가 원본 데이터와 일치하는지 확인

### 🍷 와인색 타임라인 테스트
- 국기 클릭 → 프로젝트 히스토리 모달 표시 확인
- 프로젝트 기간 정보가 없는 국가에서 와인색 타임라인 표시 확인
- 타임라인 수평 스크롤 작동 확인 (마우스 드래그/휠 스크롤)
- 년도 마커와 프로젝트 뱃지 정확한 위치 표시 확인
- 카테고리별 색상 구분 확인 (컨설팅: 하늘색, ODA: 주황색)

### 🎨 UI/UX 테스트
- **통합 필터바**: 검색과 카테고리 필터가 한 줄에 배치 확인
- **독립 편집 버튼**: 화면 우상단 고정 위치 확인
- **4개국 국기 레이아웃**: 각 대륙별 4개국/줄 표시 확인
- **국가명 전체 표시**: 긴 국가명 줄바꿈 표시 확인
- **기본 필터 상태**: 페이지 로드 시 컨설팅+ODA 모두 활성화 확인

### 📱 모바일 반응형 테스트
- 모바일에서 하단 패널 33% 높이 확인
- 지도 중심점 자동 조정 작동 확인
- 4개국 국기 그리드 모바일에서 정상 표시 확인
- 무한 스크롤 제한 작동 확인 (지도 경계)

### 🎯 고급 기능 테스트
- 카테고리 필터 토글 → 기술컨설팅/ODA 개별 필터링 확인
- 팝업 클릭 → 카테고리별 색상 테두리 (컨설팅: 파랑, ODA: 주황) 확인
- 편집 모드 → 새 지점 추가/수정/삭제 전체 워크플로 확인

## 🏗️ 아키텍처 세부사항 (v1.9)

### 핵심 함수들
- `showCountryStats(country)`: 국가별 프로젝트 히스토리 모달 표시
- `showOverview()`: 개황 팝업 표시 (전체 프로젝트 타임라인)
- `generateFullProjectTimeline(projects)`: Compact + Gantt 와인 타임라인 생성
- `generateOverviewTimeline(projects)`: 개황 전용 컴팩트 타임라인 생성
- `getProjectStartYear(p)` / `getProjectEndYear(p)`: 강화된 파서로 시작/종료 연도 추출 (날짜 파싱 정확도 개선)
- `parseYearRange(range)` / `formatPeriodYears(p)`: 연도 범위 파싱 및 표시 (연도 순서 정확화)
- `adjustMapCenter()`: 패널 위치를 고려한 지도 중심점 자동 조정
- `attachCountryHubHandlers()`: 국기 클릭 이벤트 핸들러 연결
- `toggleCategoryFilter(category)`: 카테고리 필터 토글 기능

### CSS 클래스들
- `.new-timeline-design-container`: 타임라인 컨테이너 (최적화된 높이 50vh)
- `.wine-timeline`: 와인색 타임라인 컨테이너(컴팩트)
- `.wine-timeline-line`: 메인 타임라인 선 (#722F37)
- `.wine-year-marker`: 연도 마커(선 위 굵은 점 + 아래 라벨)
- `.wine-project-badge`: 프로젝트 뱃지(간트 레인 배치)
- `.country-stats-modal-content`: 국가 통계 모달 (최대 높이 80vh)
- `.country-stats-modal-body`: 모달 바디 (최대 높이 65vh, 하단 패딩 8px)
- `.edit-button-container`: 독립 편집 버튼 컨테이너 (position: fixed)
- `.country-hub-main-toolbar`: 통합 필터바 컨테이너

### 데이터 흐름
1. **페이지 로드**: JSON 로드 → 마커 렌더링(두 카테고리 기본 활성화)
2. **국기 클릭**: `showCountryStats()` → 국가별 프로젝트 히스토리 모달 표시
3. **개황 버튼 클릭**: `showOverview()` → 전체 프로젝트 타임라인 모달 표시 (최적화된 공백)
4. **타임라인 생성**: `generateFullProjectTimeline()`로 단일 라인 + 간트 레인 배치
5. **스크롤 처리**: 수평 스크롤(overflow-x: auto), 현재시점 자동 스크롤
6. **모바일 대응**: 패널 33vh, 지도 중심 자동 조정, 핀치 줌 지원

### 성능 최적화
- **지도 무한 스크롤 방지**: `worldCopyJump: false`, `maxBounds` 설정
- **이벤트 델리게이션**: 국기 클릭을 부모 요소에서 처리
- **동적 CSS 적용**: 팝업 테두리·타임라인 높이/라인 위치 런타임 계산
- **반응형 최적화**: CSS Grid (4개국/줄) + Flexbox (통합 필터바)
- **모달 공간 최적화**: 높이 제한(80vh), 패딩 최소화, 자동 크기 조정
- **타임라인 효율성**: 컨테이너 높이 50vh 제한, 스크롤 영역 최적화
- **메모리 관리**: 타임라인 래퍼 기본 높이 600px→400px, 여백 200px→100px 축소

### 날짜 파싱(강화) - v1.9 개선
- **지원 포맷**: `'72-10`, `'20-'25`, `2005-06`, `2018-2022`, `1998` 등
- **2자리 연도 규칙**: `00~29 → 2000~2029`, `30~99 → 1930~1999`
- **월/연도 구분 정확화**: 'YY-MM 형식에서 월(1-12)과 연도 구분 개선
- **데이터 정규화**: backtick(`) → apostrophe(') 변환으로 파싱 안정성 확보
- **연도 순서 유지**: 자동 연도 교체 로직 제거로 원본 데이터 순서 보존
- **소스별 추출**: ODA는 `period`, 컨설팅은 `startDate/endDate`에서 시작/종료 연도 추출

### 안정성/로딩
- 반드시 서버로 열기: `file://` 환경에서 `fetch`는 실패함 → `npm start` 또는 `bash scripts/serve.sh`
- CDN 의존: Leaflet는 CDN 사용. 네트워크 차단 시 초기화 실패 가능
- 워치독: 8초 내 초기화 실패 시 로딩 숨김 + 경고 토스트 표시
